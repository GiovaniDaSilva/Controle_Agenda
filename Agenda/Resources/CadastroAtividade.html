<html lang="pr-bt">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {p_links_comum_pagina}


    <!--Seleção da linha da tabela-->
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.1/css/select.bootstrap4.min.css" />

    <!--Converte Tabela em Json-->
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js" integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>

    <style>
        [p_style_comum_pagina]

        .botaoSubMenu {
            border: none;
        }

        .label {
            font-weight: bold;
        }

        /*

        scroll sem um table comum
        <div class="table-wrapper-scroll-y my-custom-scrollbar col-md-5"> table... </div>
        .my-custom-scrollbar {
            position: relative;
            height: 200px;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
        }

        */

        .thead-blue {
            color: black;
            background-color: cornflowerblue;
            border-color: cornflowerblue;
        }
    </style>

    {p_titulo_pagina}

</head>


<body class="Fundo">
    <header>
        {p_menu_pagina}

        <!--Sub Menu-->
        <nav class="navbar navbar-light Fundo">
            <div>
                <button class="btn btn-success" type="submit" form="form_dados">Salvar</button>
                <input id="btnLimpa" type="reset" value="Limpar" form="form_dados" class=" btn btn-warning" />
            </div>
        </nav>

    </header>

    <div class="container-fluid">
        <form method="post" id="form_dados" style="margin-top: 30px; margin-bottom: 40px">
            <div class="form-row">

                <!--Campo data-->
                <div class="form-group col-md-2">
                    <label for="dataAtividade" class="label">Data</label>
                    <input type="date" class="form-control" id="dataAtividade" name="dataAtividade" form="form_dados">
                </div>
                &nbsp;

                <!--Campo Tipo-->
                <div class="form-group col-md-2">
                    <label for="tipoAtividade" class="label">Tipo de Atividade</label>
                    <select class="custom-select" select id="tipoAtividade" name="tipoAtividade" form="form_dados">
                        <option value="1"> Solicitação</option>
                        <option value="2"> PBI</option>
                        <option value="3"> Reunião</option>
                        <option value="4"> Ausente</option>
                        <option value="5"> Outros</option>
                    </select>
                </div>
                &nbsp;
                <!--Campo Código-->
                <div class="form-group col-md-1">
                    <label for="codigoAtividade" class="label">Codigo</label>
                    <input type="number" class="form-control" id="codigoAtividade" name="codigoAtividade" form="form_dados">
                </div>
                &nbsp;

                <!--Campo Horas Totais-->
                <div class="form-group col-md-1">
                    <label for="horaTotal" class="label">Total</label>
                    <input readonly type="time" class="form-control" id="horaTotal" name="horaTotal" form="form_dados">
                </div>

            </div>

            <!--Hora inicial - Final-->
            <div class="form-row">

                <!--Campo inicio-->
                <div class="form-group col-md-1">
                    <label for="horaInicio" class="label">De</label>
                    <input type="time" class="form-control" id="horaInicio" name="horaInicio" form="form_dados">
                </div>
                &nbsp;

                <!--Campo fim-->
                <div class="form-group col-md-1">
                    <label for="horaFinal" class="label">Até</label>
                    <input type="time" class="form-control" id="horaFinal" name="horaFinal" form="form_dados">
                </div>

                <!--Grid de Periodos-->
                <div id="dadosHome" class="form-row col-md-9">
                    <div style="margin-top: 20px;" class="col-md-5">
                        <table id="dados" class="table table-sm nowrap" cellspacing="0" form="form_dados" name="tabelaPeriodos">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>De</th>
                                    <th>Ate</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!--
                                    {p_linhas_tabela_periodo}
                                 -->
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>


            <!--Botão Adicionar Periodo-->
            <div class="form-row">
                <div class="form-group col-md-1">
                    <button id="btnAdicionarPeriodo" class="btn btn-info" type="button" form="form_dados">Adicionar</button>
                </div>
            </div>

            <!--Campo Descrição-->
            <div class="form-row">
                <div class="form-group col-md-6">

                    <div class="form-group" style="margin-top: 40px">
                        <label for="descricaoAtividade" class="label">Descrição</label>
                        <textarea class="form-control" rows="10" id="descricaoAtividade" name="descricaoAtividade"></textarea>
                    </div>

                </div>
            </div>


        </form>
    </div>



    <script>

        $(document).ready(function () {
            tb = $('#dados').DataTable({
                "scrollY": "100px", //Altura da grid com scroll
                "scrollCollapse": true,
                paging: false,
                searching: false,
                info: false,
                select: {
                    style: 'single' //permitir selecionar apenas uma linha
                },

                oLanguage: { sUrl: '//cdn.datatables.net/plug-ins/1.10.20/i18n/Portuguese-Brasil.json' },
            });


            //Seleção da Atividade
            tb.on('select.dt deselect.dt', function () {

            });


            //Click do botao adicionar periodo
            $('#btnAdicionarPeriodo').on('click', function () {
                AdicionaPeiodoGrid(tb);
            });


            document.getElementById('dataAtividade').value = RetornaDataAtual();

            [p_inicializa_campos_atividade]
                        
            var id = [p_id_atividade];                       
            
            if (id > 0) {
                $.ajax({
                    url: 'home_get_descricao',
                    type: 'POST',
                    dataType: 'text',//'json',
                    data: id + "", //Força a conversão para string

                    success: function (descricao) {
                        document.getElementById('descricaoAtividade').value = descricao;
                    }
                });
            }

        });



        function AdicionaPeiodoGrid(tb) {

            var ini = document.getElementById('horaInicio').value
            var fim = document.getElementById('horaFinal').value;
            var tot = diff(ini, fim);

            if (ini == '') {
                alert('Informe a hora de inicio.')
                return
            }

            if (fim == '') {
                alert('Informe a hora de final.')
                return
            }

            tb.row.add([
                0, //ID
                ini, //Inicio
                fim, //Final
                tot // Total
            ]).draw(false);

            //Limpa os campos de horas
            document.getElementById('horaInicio').value = "";
            document.getElementById('horaFinal').value = "";

            //Pega hora total, ou alimenta se ainda não tiver
            var hora = document.getElementById('horaTotal').value;
            if (hora == '') { hora = '00:00'; }

            document.getElementById('horaTotal').value = somaHora(hora, tot, false);
        };

        //Evento de submit do formulario
        $("#form_dados").submit(function (e) {
            e.preventDefault();

            var data = document.getElementById('dataAtividade').value;
            if (data == '') {
                alert('Informe a data da atividade.');
                return
            }


            var json = ConvertFormToJSON("#form_dados");

            $.ajax({
                cache: false,
                url: 'CadastroAtividade_salvar',
                type: 'POST',
                dataType: 'text',
                data: json,

                success: function (descricao) {
                    alert("Gravado com sucesso!");
                    document.getElementById("btnLimpa").click();
                },

                error: function (descricao) {
                    alert("Ocorreu um erro: " + descricao);
                }

            });

        });

        [p_funcao_retorna_data_atual]

        [p_funcao_calcula_soma_horas]

        [p_funcao_calcula_diferencao_horas]

        [p_funcao_converte_form_to_json]

    </script>


</body>


</html>