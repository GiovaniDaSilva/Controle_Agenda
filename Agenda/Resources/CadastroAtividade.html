<html lang="pr-bt">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {p_links_comum_pagina}


    <!--Seleção da linha da tabela-->
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.1/css/select.bootstrap4.min.css" />

    <!--Converte Tabela em Json-->
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js" integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>

    <style>
        [p_style_comum_pagina]

        .botaoSubMenu {
            border: none;
        }

        .label {
            font-weight: bold;
        }

        /*

        scroll sem um table comum
        <div class="table-wrapper-scroll-y my-custom-scrollbar col-md-5"> table... </div>
        .my-custom-scrollbar {
            position: relative;
            height: 200px;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
        }

        */

        .thead-blue {
            color: black;
            background-color: cornflowerblue;
            border-color: cornflowerblue;
        }
    </style>

    {p_titulo_pagina}

</head>


<body class="Fundo">
    <header>
        {p_menu_pagina}

        <!--Sub Menu-->
        <nav class="navbar navbar-light Fundo">
            <div>
                <button class="btn btn-primary btn-outline-light botaoSubMenu" type="submit" form="form_dados">Salvar</button>
                <input type="reset" value="Limpar" form="form_dados" class=" btn btn-primary btn-outline-light botaoSubMenu" />

                <button id="btnAdicionarPeriodo" class="btn btn-primary btn-outline-light botaoSubMenu" type="button" form="form_dados">Adicionar periodo</button>
            </div>
        </nav>

    </header>

    <div class="container-fluid">
        <form method="post" id="form_dados" style="margin-top: 30px; margin-bottom: 40px">
            <div class="form-row">

                <!--Campo data-->
                <div class="form-group col-md-2">
                    <label for="dataAtividade" class="label">Data</label>
                    <input type="date" class="form-control" id="dataAtividade" name="dataAtividade" form="form_dados">
                </div>
                &nbsp;

                <!--Campo Tipo-->
                <div class="form-group col-md-2">
                    <label for="tipoAtividade" class="label">Tipo de Atividade</label>
                    <select class="custom-select" select id="tipoAtividade" name="tipoAtividade" form="form_dados">
                        <option value="1"> Solicitação</option>
                        <option value="2"> PBI</option>
                        <option value="3"> Reunião</option>
                        <option value="4"> Ausente</option>
                        <option value="5"> Outros</option>
                    </select>
                </div>
                &nbsp;
                <!--Campo Código-->
                <div class="form-group col-md-1">
                    <label for="codigoAtividade" class="label">Codigo</label>
                    <input type="number" class="form-control" id="codigoAtividade" name="codigoAtividade" form="form_dados">
                </div>
                &nbsp;

                <!--Campo Horas Totais-->
                <div class="form-group col-md-1">
                    <label for="horaTotal" class="label">Total</label>
                    <input type="time" class="form-control" id="horaTotal" name="horaTotal" form="form_dados">
                </div>

            </div>

            <!--Hora inicial - Final-->
            <div class="form-row">

                <!--Campo inicio-->
                <div class="form-group col-md-1">
                    <label for="horaInicio" class="label">De</label>
                    <input type="time" class="form-control" id="horaInicio" name="horaInicio" form="form_dados">
                </div>
                &nbsp;

                <!--Campo fim-->
                <div class="form-group col-md-1">
                    <label for="horaFinal" class="label">Até</label>
                    <input type="time" class="form-control" id="horaFinal" name="horaFinal" form="form_dados">
                </div>

                <!--Grid de Periodos-->
                <div id="dadosHome" class="form-row col-md-9">
                    <div style="margin-top: 20px;" class="col-md-5">
                        <table id="dados" class="table table-sm nowrap" cellspacing="0" form="form_dados" name="tabelaPeriodos">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>De</th>
                                    <th>Ate</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>08:00</td>
                                    <td>10:30</td>
                                    <td>02:30</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>


            <!--Campo Descrição-->
            <div class="form-row">
                <div class="form-group col-md-6">

                    <div class="form-group" style="margin-top: 40px">
                        <label for="descricaoAtividade" class="label">Descrição</label>
                        <textarea class="form-control" rows="10" id="descricaoAtividade" name="descricaoAtividade"></textarea>
                    </div>

                </div>
            </div>


        </form>
    </div>



    <script>

        $(document).ready(function () {
            tb = $('#dados').DataTable({
                "scrollY": "100px", //Altura da grid com scroll
                "scrollCollapse": true,
                paging: false,
                searching: false,
                info: false,
                select: {
                    style: 'single' //permitir selecionar apenas uma linha
                },

                oLanguage: { sUrl: '//cdn.datatables.net/plug-ins/1.10.20/i18n/Portuguese-Brasil.json' },
            });


            //Seleção da Atividade
            tb.on('select.dt deselect.dt', function () {

            });


            //Click do botao adicionar periodo
            $('#btnAdicionarPeriodo').on('click', function () {
                AdicionaPeiodoGrid(tb);
            });

        });


        function AdicionaPeiodoGrid(tb) {

            var ini = document.getElementById('horaInicio').value
            var fim = document.getElementById('horaFinal').value;
            var tot = diff(ini, fim);

            tb.row.add([
                0, //ID
                ini,
                fim,
                tot
            ]).draw(false);

            //Limpa os campos de horas
            document.getElementById('horaInicio').value = "";
            document.getElementById('horaFinal').value = "";
        };

        //Calcula a diferença entre as horas
        //https://stackoverflow.com/questions/10804042/calculate-time-difference-with-javascript
        function diff(start, end) {
            start = start.split(":");
            end = end.split(":");
            var startDate = new Date(0, 0, 0, start[0], start[1], 0);
            var endDate = new Date(0, 0, 0, end[0], end[1], 0);
            var diff = endDate.getTime() - startDate.getTime();
            var hours = Math.floor(diff / 1000 / 60 / 60);
            diff -= hours * 1000 * 60 * 60;
            var minutes = Math.floor(diff / 1000 / 60);

            // If using time pickers with 24 hours format, add the below line get exact hours
            if (hours < 0)
                hours = hours + 24;

            return (hours <= 9 ? "0" : "") + hours + ":" + (minutes <= 9 ? "0" : "") + minutes;
        }

        //Converte a tabela em json
        //Tenho que ver como referenciar esse projeto no meu projeto do github
        //https://github.com/lightswitch05/table-to-json


        //Metodo para montar o json
        function ConvertFormToJSON(form) {

            var array = jQuery(form).serializeArray();
            var json = {};

            //monta o json com id dos campos e conteudo
            jQuery.each(array, function () {
                json[this.name] = this.value || '';
            });


            //Adicionado a tabela ao json
            var table = $('#dados').tableToJSON();
            json['Periodo'] = table;


            return JSON.stringify(json);
        };





        //Evento de submit do formulario
        $("#form_dados").submit(function (e) {
            e.preventDefault();

            var json = ConvertFormToJSON("#form_dados");

            $.ajax({
                cache: false,
                url: 'CadastroAtividade_salvar',
                type: 'POST',
                dataType: 'text',
                data: json,

                success: function (descricao) {
                    alert("sucesso");
                    document.getElementById('descricaoAtividade').value = descricao;
                },

                error: function (descricao) {
                    alert("Ocorreu um erro: " + descricao);
                }

            });


        });

    </script>


</body>


</html>